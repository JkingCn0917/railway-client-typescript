"use strict";
var __extends = (this && this.__extends) || (function () {
    var extendStatics = Object.setPrototypeOf ||
        ({ __proto__: [] } instanceof Array && function (d, b) { d.__proto__ = b; }) ||
        function (d, b) { for (var p in b) if (b.hasOwnProperty(p)) d[p] = b[p]; };
    return function (d, b) {
        extendStatics(d, b);
        function __() { this.constructor = d; }
        d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
    };
})();
Object.defineProperty(exports, "__esModule", { value: true });
var fs = require("fs");
var crypto = require("crypto");
var tough = require("tough-cookie");
var FileCookieStore = /** @class */ (function (_super) {
    __extends(FileCookieStore, _super);
    function FileCookieStore(filePath, option) {
        var _this = _super.call(this) || this;
        _this.idx = {}; // idx is memory cache
        _this.filePath = filePath;
        option = option || {};
        option.encrypt = !(option.encrypt === false);
        if (option.encrypt) {
            option.algorithm = option.algorithm || 'aes-256-cbc';
            option.password = option.password || 'tough-cookie-store';
        }
        _this.option = option;
        var self = _this;
        _this.loadFromFile(_this.filePath, option, function (dataJson) {
            if (dataJson)
                self.idx = dataJson;
        });
        return _this;
    }
    FileCookieStore.prototype.putCookie = function (cookie, cb) {
        if (!this.idx[cookie.domain]) {
            this.idx[cookie.domain] = {};
        }
        if (!this.idx[cookie.domain][cookie.path]) {
            this.idx[cookie.domain][cookie.path] = {};
        }
        this.idx[cookie.domain][cookie.path][cookie.key] = cookie;
        this.saveToFile(this.filePath, this.idx, this.option, cb);
    };
    FileCookieStore.prototype.removeCookie = function (domain, path, key, cb) {
        if (this.idx[domain] && this.idx[domain][path] && this.idx[domain][path][key]) {
            delete this.idx[domain][path][key];
        }
        this.saveToFile(this.filePath, this.idx, this.option, cb);
    };
    FileCookieStore.prototype.removeCookies = function (domain, path, cb) {
        if (this.idx[domain]) {
            if (path) {
                delete this.idx[domain][path];
            }
            else {
                delete this.idx[domain];
            }
        }
        this.saveToFile(this.filePath, this.idx, this.option, cb);
    };
    FileCookieStore.prototype.getCookie = function (domain, path, key) {
        if (!this.idx[domain]) {
            return undefined;
        }
        if (!this.idx[domain][path]) {
            return undefined;
        }
        return this.idx[domain][path][key];
    };
    FileCookieStore.prototype.flush = function () {
        this.saveToFile(this.filePath, this.idx, this.option);
    };
    ;
    FileCookieStore.prototype.isEmpty = function () {
        return this.isEmptyObject(this.idx);
    };
    FileCookieStore.prototype.isEmptyObject = function (obj) {
        for (var key in obj) {
            if (obj.hasOwnProperty.call(obj, key)) {
                return false;
            }
        }
        return true;
    };
    FileCookieStore.prototype.saveToFile = function (filePath, data, option, cb) {
        var dataJson = JSON.stringify(data);
        if (option.encrypt) {
            var cipher = crypto.createCipher(option.algorithm || '', option.password || '');
            dataJson = cipher.update(dataJson, 'utf8', 'hex');
            dataJson += cipher.final('hex');
        }
        fs.writeFileSync(filePath, dataJson);
        if (typeof cb === 'function')
            cb();
    };
    FileCookieStore.prototype.loadFromFile = function (filePath, option, cb) {
        var data = fs.readFileSync(filePath, { encoding: 'utf8', flag: 'a+' });
        if (option.encrypt && data) {
            var decipher = crypto.createDecipher(option.algorithm || '', option.password || '');
            data = decipher.update(data, 'hex', 'utf8');
            data += decipher.final('utf8');
        }
        var dataJson = data ? JSON.parse(data) : null;
        for (var domainName in dataJson) {
            for (var pathName in dataJson[domainName]) {
                for (var cookieName in dataJson[domainName][pathName]) {
                    dataJson[domainName][pathName][cookieName] = tough.fromJSON(JSON.stringify(dataJson[domainName][pathName][cookieName]));
                }
            }
        }
        cb(dataJson);
    };
    return FileCookieStore;
}(tough.MemoryCookieStore));
exports.FileCookieStore = FileCookieStore;

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9GaWxlQ29va2llU3RvcmUudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7O0FBQ0EsdUJBQTBCO0FBQzFCLCtCQUFrQztBQUNsQyxvQ0FBdUM7QUFnQnZDO0lBQXFDLG1DQUF1QjtJQUsxRCx5QkFBWSxRQUFnQixFQUFFLE1BQWM7UUFBNUMsWUFDRSxpQkFBTyxTQWdCUjtRQWRDLEtBQUksQ0FBQyxHQUFHLEdBQUcsRUFBRSxDQUFDLENBQUMsc0JBQXNCO1FBQ3JDLEtBQUksQ0FBQyxRQUFRLEdBQUcsUUFBUSxDQUFDO1FBQ3pCLE1BQU0sR0FBRyxNQUFNLElBQUksRUFBRSxDQUFDO1FBQ3RCLE1BQU0sQ0FBQyxPQUFPLEdBQUcsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxPQUFPLEtBQUssS0FBSyxDQUFDLENBQUM7UUFDN0MsRUFBRSxDQUFDLENBQUMsTUFBTSxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUM7WUFDakIsTUFBTSxDQUFDLFNBQVMsR0FBRyxNQUFNLENBQUMsU0FBUyxJQUFJLGFBQWEsQ0FBQztZQUNyRCxNQUFNLENBQUMsUUFBUSxHQUFHLE1BQU0sQ0FBQyxRQUFRLElBQUksb0JBQW9CLENBQUM7UUFDOUQsQ0FBQztRQUNELEtBQUksQ0FBQyxNQUFNLEdBQUcsTUFBTSxDQUFDO1FBQ3JCLElBQUksSUFBSSxHQUFHLEtBQUksQ0FBQztRQUNoQixLQUFJLENBQUMsWUFBWSxDQUFDLEtBQUksQ0FBQyxRQUFRLEVBQUUsTUFBTSxFQUFFLFVBQUMsUUFBYTtZQUNuRCxFQUFFLENBQUMsQ0FBQyxRQUFRLENBQUM7Z0JBQ1QsSUFBSSxDQUFDLEdBQUcsR0FBRyxRQUFRLENBQUM7UUFDNUIsQ0FBQyxDQUFDLENBQUM7O0lBQ0wsQ0FBQztJQUVNLG1DQUFTLEdBQWhCLFVBQWlCLE1BQW9CLEVBQUUsRUFBYTtRQUNoRCxFQUFFLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsTUFBTSxDQUFDLE1BQU0sQ0FBQyxD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UyxDQUFDLFFBQVEsQ0FBQyxVQUFVLENBQUMsQ0FBQyxRQUFRLENBQUMsQ0FBQyxVQUFVLENBQUMsQ0FBQyxDQUFDLENBQUM7Z0JBQzVILENBQUM7WUFDTCxDQUFDO1FBQ0wsQ0FBQztRQUNELEVBQUUsQ0FBQyxRQUFRLENBQUMsQ0FBQztJQUNqQixDQUFDO0lBQ0gsc0JBQUM7QUFBRCxDQTdHQSxBQTZHQyxDQTdHb0MsS0FBSyxDQUFDLGlCQUFpQixHQTZHM0Q7QUE3R1ksMENBQWUiLCJmaWxlIjoic3JjL0ZpbGVDb29raWVTdG9yZS5qcyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB1dGlsID0gcmVxdWlyZSgndXRpbCcpO1xyXG5pbXBvcnQgZnMgPSByZXF1aXJlKCdmcycpO1xyXG5pbXBvcnQgY3J5cHRvID0gcmVxdWlyZSgnY3J5cHRvJyk7XHJcbmltcG9ydCB0b3VnaCA9IHJlcXVpcmUoJ3RvdWdoLWNvb2tpZScpO1xyXG5cclxuZXhwb3J0IGludGVyZmFjZSBPcHRpb24ge1xyXG4gIGVuY3J5cHQ6IGJvb2xlYW47XHJcbiAgYWxnb3JpdGhtPzogc3RyaW5nO1xyXG4gIHBhc3N3b3JkPzogc3RyaW5nO1xyXG59XHJcblxyXG5pbnRlcmZhY2UgSWR4RGF0YSB7XHJcbiAgW3A6IHN0cmluZ106IGFueTtcclxufVxyXG5cclxuZXhwb3J0IGludGVyZmFjZSBDYWxsYmFjayB7XHJcbiAgKHBhcmFtPzogYW55fHZvaWQpOiBhbnl8dm9pZFxyXG59XHJcblxyXG5leHBvcnQgY2xhc3MgRmlsZUNvb2tpZVN0b3JlIGV4dGVuZHMgdG91Z2guTWVtb3J5Q29va2llU3RvcmUge1xyXG4gIHByaXZhdGUgaWR4OiBJZHhEYXRhO1xyXG4gIHByaXZhdGUgZmlsZVBhdGg6IHN0cmluZztcclxuICBwcml2YXRlIG9wdGlvbjogT3B0aW9uO1xyXG5cclxuICBjb25zdHJ1Y3RvcihmaWxlUGF0aDogc3RyaW5nLCBvcHRpb246IE9wdGlvbikge1xyXG4gICAgc3VwZXIoKTtcclxuXHJcbiAgICB0aGlzLmlkeCA9IHt9OyAvLyBpZHggaXMgbWVtb3J5IGNhY2hlXHJcbiAgICB0aGlzLmZpbGVQYXRoID0gZmlsZVBhdGg7XHJcbiAgICBvcHRpb24gPSBvcHRpb24gfHwge307XHJcbiAgICBvcHRpb24uZW5jcnlwdCA9ICEob3B0aW9uLmVuY3J5cHQgPT09IGZhbHNlKTtcclxuICAgIGlmIChvcHRpb24uZW5jcnlwdCkge1xyXG4gICAgICAgIG9wdGlvbi5hbGdvcml0aG0gPSBvcHRpb24uYWxnb3JpdGhtIHx8ICdhZXMtMjU2LWNiYyc7XHJcbiAgICAgICAgb3B0aW9uLnBhc3N3b3JkID0gb3B0aW9uLnBhc3N3b3JkIHx8ICd0b3VnaC1jb29raWUtc3RvcmUnO1xyXG4gICAgfVxyXG4gICAgdGhpcy5vcHRpb24gPSBvcHRpb247XHJcbiAgICB2YXIgc2VsZiA9IHRoaXM7XHJcbiAgICB0aGlzLmxvYWRGcm9tRmlsZSh0aGlzLmZpbGVQYXRoLCBvcHRpb24sIChkYXRhSnNvbjogYW55KT0+IHtcclxuICAgICAgICBpZiAoZGF0YUpzb24pXHJcbiAgICAgICAgICAgIHNlbGYuaWR4ID0gZGF0YUpzb247XHJcbiAgICB9KTtcclxuICB9XHJcblxyXG4gIHB1YmxpYyBwdXRDb29raWUoY29va2llOiB0b3VnaC5Db29raWUsIGNiPzogQ2FsbGJhY2spOiB2b2lkIHtcclxuICAgICAgaWYgKCF0aGlzLmlkeFtjb29raWUuZG9tYWluXSkge1xyXG4gICAgICAgICAgdGhpcy5pZHhbY29va2llLmRvbWFpbl0gPSB7fTtcclxuICAgICAgfVxyXG4gICAgICBpZiAoIXRoaXMuaWR4W2Nvb2tpZS5kb21haW5dW2Nvb2tpZS5wYXRoXSkge1xyXG4gICAgICAgICAgdGhpcy5pZHhbY29va2llLmRvbWFpbl1bY29va2llLnBhdGhdID0ge307XHJcbiAgICAgIH1cclxuICAgICAgdGhpcy5pZHhbY29va2llLmRvbWFpbl1bY29va2llLnBhdGhdW2Nvb2tpZS5rZXldID0gY29va2llO1xyXG5cclxuICAgICAgdGhpcy5zYXZlVG9GaWxlKHRoaXMuZmlsZVBhdGgsIHRoaXMuaWR4LCB0aGlzLm9wdGlvbiwgY2IpO1xyXG4gIH1cclxuXHJcbiAgcHVibGljIHJlbW92ZUNvb2tpZShkb21haW46IHN0cmluZywgcGF0aDogc3RyaW5nLCBrZXk6IHN0cmluZywgY2I/OiBDYWxsYmFjayk6IHZvaWQge1xyXG4gICAgICBpZiAodGhpcy5pZHhbZG9tYWluXSAmJiB0aGlzLmlkeFtkb21haW5dW3BhdGhdICYmIHRoaXMuaWR4W2RvbWFpbl1bcGF0aF1ba2V5XSkge1xyXG4gICAgICAgICAgZGVsZXRlIHRoaXMuaWR4W2RvbWFpbl1bcGF0aF1ba2V5XTtcclxuICAgICAgfVxyXG4gICAgICB0aGlzLnNhdmVUb0ZpbGUodGhpcy5maWxlUGF0aCwgdGhpcy5pZHgsIHRoaXMub3B0aW9uLCBjYik7XHJcbiAgfVxyXG5cclxuICBwdWJsaWMgcmVtb3ZlQ29va2llcyhkb21haW46IHN0cmluZywgcGF0aDogc3RyaW5nLCBjYj86IENhbGxiYWNrKSB7XHJcbiAgICAgIGlmICh0aGlzLmlkeFtkb21haW5dKSB7XHJcbiAgICAgICAgICBpZiAocGF0aCkge1xyXG4gICAgICAgICAgICAgIGRlbGV0ZSB0aGlzLmlkeFtkb21haW5dW3BhdGhdO1xyXG4gICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICBkZWxldGUgdGhpcy5pZHhbZG9tYWluXTtcclxuICAgICAgICAgIH1cclxuICAgICAgfVxyXG4gICAgICB0aGlzLnNhdmVUb0ZpbGUodGhpcy5maWxlUGF0aCwgdGhpcy5pZHgsIHRoaXMub3B0aW9uLCBjYik7XHJcbiAgfVxyXG5cclxuICBwdWJsaWMgZ2V0Q29va2llKGRvbWFpbjogc3RyaW5nLCBwYXRoOiBzdHJpbmcsIGtleTogc3RyaW5nKSB7XHJcbiAgICAgIGlmICghdGhpcy5pZHhbZG9tYWluXSkge1xyXG4gICAgICAgICAgcmV0dXJuIHVuZGVmaW5lZDtcclxuICAgICAgfVxyXG4gICAgICBpZiAoIXRoaXMuaWR4W2RvbWFpbl1bcGF0aF0pIHtcclxuICAgICAgICAgIHJldHVybiB1bmRlZmluZWQ7XHJcbiAgICAgIH1cclxuICAgICAgcmV0dXJuIHRoaXMuaWR4W2RvbWFpbl1bcGF0aF1ba2V5XTtcclxuICB9XHJcblxyXG4gIHB1YmxpYyBmbHVzaCgpIHtcclxuICAgICAgdGhpcy5zYXZlVG9GaWxlKHRoaXMuZmlsZVBhdGgsIHRoaXMuaWR4LCB0aGlzLm9wdGlvbik7XHJcbiAgfTtcclxuXHJcbiAgcHVibGljIGlzRW1wdHkoKSB7XHJcbiAgICAgIHJldHVybiB0aGlzLmlzRW1wdHlPYmplY3QodGhpcy5pZHgpO1xyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSBpc0VtcHR5T2JqZWN0KG9iajogb2JqZWN0KSB7XHJcbiAgICAgIGZvciAodmFyIGtleSBpbiBvYmopIHtcclxuICAgICAgICAgIGlmIChvYmouaGFzT3duUHJvcGVydHkuY2FsbChvYmosIGtleSkpIHtcclxuICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7XHJcbiAgICAgICAgICB9XHJcbiAgICAgIH1cclxuICAgICAgcmV0dXJuIHRydWU7XHJcbiAgfVxyXG5cclxuICBwcml2YXRlIHNhdmVUb0ZpbGUoZmlsZVBhdGg6IHN0cmluZywgZGF0YTogSWR4RGF0YSwgb3B0aW9uOiBPcHRpb24sIGNiPzogQ2FsbGJhY2spOiB2b2lkIHtcclxuICAgICAgdmFyIGRhdGFKc29uID0gSlNPTi5zdHJpbmdpZnkoZGF0YSk7XHJcbiAgICAgIGlmIChvcHRpb24uZW5jcnlwdCkge1xyXG4gICAgICAgICAgdmFyIGNpcGhlciA9IGNyeXB0by5jcmVhdGVDaXBoZXIob3B0aW9uLmFsZ29yaXRobXx8JycsIG9wdGlvbi5wYXNzd29yZHx8JycpO1xyXG4gICAgICAgICAgZGF0YUpzb24gPSBjaXBoZXIudXBkYXRlKGRhdGFKc29uLCAndXRmOCcsICdoZXgnKTtcclxuICAgICAgICAgIGRhdGFKc29uICs9IGNpcGhlci5maW5hbCgnaGV4Jyk7XHJcbiAgICAgIH1cclxuICAgICAgZnMud3JpdGVGaWxlU3luYyhmaWxlUGF0aCwgZGF0YUpzb24pO1xyXG4gICAgICBpZiAodHlwZW9mIGNiID09PSAnZnVuY3Rpb24nKSBjYigpO1xyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSBsb2FkRnJvbUZpbGUoZmlsZVBhdGg6IHN0cmluZywgb3B0aW9uOiBPcHRpb24sIGNiOiBDYWxsYmFjayk6IHZvaWQge1xyXG4gICAgICB2YXIgZGF0YSA9IGZzLnJlYWRGaWxlU3luYyhmaWxlUGF0aCwge2VuY29kaW5nOiAndXRmOCcsIGZsYWc6ICdhKyd9KTtcclxuICAgICAgaWYgKG9wdGlvbi5lbmNyeXB0ICYmIGRhdGEpIHtcclxuICAgICAgICAgIHZhciBkZWNpcGhlciA9IGNyeXB0by5jcmVhdGVEZWNpcGhlcihvcHRpb24uYWxnb3JpdGhtfHwnJywgb3B0aW9uLnBhc3N3b3JkfHwnJyk7XHJcbiAgICAgICAgICBkYXRhID0gZGVjaXBoZXIudXBkYXRlKGRhdGEsICdoZXgnLCAndXRmOCcpO1xyXG4gICAgICAgICAgZGF0YSArPSBkZWNpcGhlci5maW5hbCgndXRmOCcpO1xyXG4gICAgICB9XHJcbiAgICAgIHZhciBkYXRhSnNvbiA9IGRhdGEgPyBKU09OLnBhcnNlKGRhdGEpIDogbnVsbDtcclxuICAgICAgZm9yICh2YXIgZG9tYWluTmFtZSBpbiBkYXRhSnNvbikge1xyXG4gICAgICAgICAgZm9yICh2YXIgcGF0aE5hbWUgaW4gZGF0YUpzb25bZG9tYWluTmFtZV0pIHtcclxuICAgICAgICAgICAgICBmb3IgKHZhciBjb29raWVOYW1lIGluIGRhdGFKc29uW2RvbWFpbk5hbWVdW3BhdGhOYW1lXSkge1xyXG4gICAgICAgICAgICAgICAgICBkYXRhSnNvbltkb21haW5OYW1lXVtwYXRoTmFtZV1bY29va2llTmFtZV0gPSB0b3VnaC5mcm9tSlNPTihKU09OLnN0cmluZ2lmeShkYXRhSnNvbltkb21haW5OYW1lXVtwYXRoTmFtZV1bY29va2llTmFtZV0pKTtcclxuICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICB9XHJcbiAgICAgIH1cclxuICAgICAgY2IoZGF0YUpzb24pO1xyXG4gIH1cclxufVxyXG4iXX0=
