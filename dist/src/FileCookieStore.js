"use strict";
var __extends = (this && this.__extends) || (function () {
    var extendStatics = Object.setPrototypeOf ||
        ({ __proto__: [] } instanceof Array && function (d, b) { d.__proto__ = b; }) ||
        function (d, b) { for (var p in b) if (b.hasOwnProperty(p)) d[p] = b[p]; };
    return function (d, b) {
        extendStatics(d, b);
        function __() { this.constructor = d; }
        d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
    };
})();
Object.defineProperty(exports, "__esModule", { value: true });
var fs = require("fs");
var crypto = require("crypto");
var tough = require("tough-cookie");
var FileCookieStore = /** @class */ (function (_super) {
    __extends(FileCookieStore, _super);
    function FileCookieStore(filePath, option) {
        var _this = _super.call(this) || this;
        _this.idx = {}; // idx is memory cache
        _this.filePath = filePath;
        option = option || {};
        option.encrypt = !(option.encrypt === false);
        if (option.encrypt) {
            option.algorithm = option.algorithm || 'aes-256-cbc';
            option.password = option.password || 'tough-cookie-store';
        }
        _this.option = option;
        var self = _this;
        _this.loadFromFile(_this.filePath, option, function (dataJson) {
            if (dataJson)
                self.idx = dataJson;
        });
        return _this;
    }
    FileCookieStore.prototype.putCookie = function (cookie, cb) {
        if (!this.idx[cookie.domain]) {
            this.idx[cookie.domain] = {};
        }
        if (!this.idx[cookie.domain][cookie.path]) {
            this.idx[cookie.domain][cookie.path] = {};
        }
        this.idx[cookie.domain][cookie.path][cookie.key] = cookie;
        this.saveToFile(this.filePath, this.idx, this.option, cb);
    };
    FileCookieStore.prototype.removeCookie = function (domain, path, key, cb) {
        if (this.idx[domain] && this.idx[domain][path] && this.idx[domain][path][key]) {
            delete this.idx[domain][path][key];
        }
        this.saveToFile(this.filePath, this.idx, this.option, cb);
    };
    FileCookieStore.prototype.removeCookies = function (domain, path, cb) {
        if (this.idx[domain]) {
            if (path) {
                delete this.idx[domain][path];
            }
            else {
                delete this.idx[domain];
            }
        }
        this.saveToFile(this.filePath, this.idx, this.option, cb);
    };
    FileCookieStore.prototype.getCookie = function (domain, path, key) {
        if (!this.idx[domain]) {
            return undefined;
        }
        if (!this.idx[domain][path]) {
            return undefined;
        }
        return this.idx[domain][path][key];
    };
    FileCookieStore.prototype.flush = function () {
        this.saveToFile(this.filePath, this.idx, this.option);
    };
    ;
    FileCookieStore.prototype.isEmpty = function () {
        return this.isEmptyObject(this.idx);
    };
    FileCookieStore.prototype.isEmptyObject = function (obj) {
        for (var key in obj) {
            if (obj.hasOwnProperty.call(obj, key)) {
                return false;
            }
        }
        return true;
    };
    FileCookieStore.prototype.saveToFile = function (filePath, data, option, cb) {
        var dataJson = JSON.stringify(data);
        if (option.encrypt) {
            var cipher = crypto.createCipher(option.algorithm || '', option.password || '');
            dataJson = cipher.update(dataJson, 'utf8', 'hex');
            dataJson += cipher.final('hex');
        }
        fs.writeFileSync(filePath, dataJson);
        if (typeof cb === 'function')
            cb();
    };
    FileCookieStore.prototype.loadFromFile = function (filePath, option, cb) {
        var data = fs.readFileSync(filePath, { encoding: 'utf8', flag: 'a+' });
        if (option.encrypt && data) {
            var decipher = crypto.createDecipher(option.algorithm || '', option.password || '');
            data = decipher.update(data, 'hex', 'utf8');
            data += decipher.final('utf8');
        }
        var dataJson = data ? JSON.parse(data) : null;
        for (var domainName in dataJson) {
            for (var pathName in dataJson[domainName]) {
                for (var cookieName in dataJson[domainName][pathName]) {
                    dataJson[domainName][pathName][cookieName] = tough.fromJSON(JSON.stringify(dataJson[domainName][pathName][cookieName]));
                }
            }
        }
        cb(dataJson);
    };
    return FileCookieStore;
}(tough.MemoryCookieStore));
exports.FileCookieStore = FileCookieStore;

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9GaWxlQ29va2llU3RvcmUudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7O0FBQ0EsdUJBQTBCO0FBQzFCLCtCQUFrQztBQUNsQyxvQ0FBdUM7QUFnQnZDO0lBQXFDLG1DQUF1QjtJQUsxRCx5QkFBWSxRQUFnQixFQUFFLE1BQWM7UUFBNUMsWUFDRSxpQkFBTyxTQWdCUjtRQWRDLEtBQUksQ0FBQyxHQUFHLEdBQUcsRUFBRSxDQUFDLENBQUMsc0JBQXNCO1FBQ3JDLEtBQUksQ0FBQyxRQUFRLEdBQUcsUUFBUSxDQUFDO1FBQ3pCLE1BQU0sR0FBRyxNQUFNLElBQUksRUFBRSxDQUFDO1FBQ3RCLE1BQU0sQ0FBQyxPQUFPLEdBQUcsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxPQUFPLEtBQUssS0FBSyxDQUFDLENBQUM7UUFDN0MsRUFBRSxDQUFDLENBQUMsTUFBTSxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUM7WUFDakIsTUFBTSxDQUFDLFNBQVMsR0FBRyxNQUFNLENBQUMsU0FBUyxJQUFJLGFBQWEsQ0FBQztZQUNyRCxNQUFNLENBQUMsUUFBUSxHQUFHLE1BQU0sQ0FBQyxRQUFRLElBQUksb0JBQW9CLENBQUM7UUFDOUQsQ0FBQztRQUNELEtBQUksQ0FBQyxNQUFNLEdBQUcsTUFBTSxDQUFDO1FBQ3JCLElBQUksSUFBSSxHQUFHLEtBQUksQ0FBQztRQUNoQixLQUFJLENBQUMsWUFBWSxDQUFDLEtBQUksQ0FBQyxRQUFRLEVBQUUsTUFBTSxFQUFFLFVBQUMsUUFBYTtZQUNuRCxFQUFFLENBQUMsQ0FBQyxRQUFRLENBQUM7Z0JBQ1QsSUFBSSxDQUFDLEdBQUcsR0FBRyxRQUFRLENBQUM7UUFDNUIsQ0FBQyxDQUFDLENBQUM7O0lBQ0wsQ0FBQztJQUVNLG1DQUFTLEdBQWhCLFVBQWlCLE1BQW9CLEVBQUUsRUFBYTtRQUNoRCxFQUFFLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsTUFBTSxDQUFDLE1BQU0sQ0FBQyxD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UyxDQUFDLFFBQVEsQ0FBQyxVQUFVLENBQUMsQ0FBQyxRQUFRLENBQUMsQ0FBQyxVQUFVLENBQUMsQ0FBQyxDQUFDLENBQUM7Z0JBQzVILENBQUM7WUFDTCxDQUFDO1FBQ0wsQ0FBQztRQUNELEVBQUUsQ0FBQyxRQUFRLENBQUMsQ0FBQztJQUNqQixDQUFDO0lBQ0gsc0JBQUM7QUFBRCxDQTdHQSxBQTZHQyxDQTdHb0MsS0FBSyxDQUFDLGlCQUFpQixHQTZHM0Q7QUE3R1ksMENBQWUiLCJmaWxlIjoic3JjL0ZpbGVDb29raWVTdG9yZS5qcyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB1dGlsID0gcmVxdWlyZSgndXRpbCcpO1xuaW1wb3J0IGZzID0gcmVxdWlyZSgnZnMnKTtcbmltcG9ydCBjcnlwdG8gPSByZXF1aXJlKCdjcnlwdG8nKTtcbmltcG9ydCB0b3VnaCA9IHJlcXVpcmUoJ3RvdWdoLWNvb2tpZScpO1xuXG5leHBvcnQgaW50ZXJmYWNlIE9wdGlvbiB7XG4gIGVuY3J5cHQ6IGJvb2xlYW47XG4gIGFsZ29yaXRobT86IHN0cmluZztcbiAgcGFzc3dvcmQ/OiBzdHJpbmc7XG59XG5cbmludGVyZmFjZSBJZHhEYXRhIHtcbiAgW3A6IHN0cmluZ106IGFueTtcbn1cblxuZXhwb3J0IGludGVyZmFjZSBDYWxsYmFjayB7XG4gIChwYXJhbT86IGFueXx2b2lkKTogYW55fHZvaWRcbn1cblxuZXhwb3J0IGNsYXNzIEZpbGVDb29raWVTdG9yZSBleHRlbmRzIHRvdWdoLk1lbW9yeUNvb2tpZVN0b3JlIHtcbiAgcHJpdmF0ZSBpZHg6IElkeERhdGE7XG4gIHByaXZhdGUgZmlsZVBhdGg6IHN0cmluZztcbiAgcHJpdmF0ZSBvcHRpb246IE9wdGlvbjtcblxuICBjb25zdHJ1Y3RvcihmaWxlUGF0aDogc3RyaW5nLCBvcHRpb246IE9wdGlvbikge1xuICAgIHN1cGVyKCk7XG5cbiAgICB0aGlzLmlkeCA9IHt9OyAvLyBpZHggaXMgbWVtb3J5IGNhY2hlXG4gICAgdGhpcy5maWxlUGF0aCA9IGZpbGVQYXRoO1xuICAgIG9wdGlvbiA9IG9wdGlvbiB8fCB7fTtcbiAgICBvcHRpb24uZW5jcnlwdCA9ICEob3B0aW9uLmVuY3J5cHQgPT09IGZhbHNlKTtcbiAgICBpZiAob3B0aW9uLmVuY3J5cHQpIHtcbiAgICAgICAgb3B0aW9uLmFsZ29yaXRobSA9IG9wdGlvbi5hbGdvcml0aG0gfHwgJ2Flcy0yNTYtY2JjJztcbiAgICAgICAgb3B0aW9uLnBhc3N3b3JkID0gb3B0aW9uLnBhc3N3b3JkIHx8ICd0b3VnaC1jb29raWUtc3RvcmUnO1xuICAgIH1cbiAgICB0aGlzLm9wdGlvbiA9IG9wdGlvbjtcbiAgICB2YXIgc2VsZiA9IHRoaXM7XG4gICAgdGhpcy5sb2FkRnJvbUZpbGUodGhpcy5maWxlUGF0aCwgb3B0aW9uLCAoZGF0YUpzb246IGFueSk9PiB7XG4gICAgICAgIGlmIChkYXRhSnNvbilcbiAgICAgICAgICAgIHNlbGYuaWR4ID0gZGF0YUpzb247XG4gICAgfSk7XG4gIH1cblxuICBwdWJsaWMgcHV0Q29va2llKGNvb2tpZTogdG91Z2guQ29va2llLCBjYj86IENhbGxiYWNrKTogdm9pZCB7XG4gICAgICBpZiAoIXRoaXMuaWR4W2Nvb2tpZS5kb21haW5dKSB7XG4gICAgICAgICAgdGhpcy5pZHhbY29va2llLmRvbWFpbl0gPSB7fTtcbiAgICAgIH1cbiAgICAgIGlmICghdGhpcy5pZHhbY29va2llLmRvbWFpbl1bY29va2llLnBhdGhdKSB7XG4gICAgICAgICAgdGhpcy5pZHhbY29va2llLmRvbWFpbl1bY29va2llLnBhdGhdID0ge307XG4gICAgICB9XG4gICAgICB0aGlzLmlkeFtjb29raWUuZG9tYWluXVtjb29raWUucGF0aF1bY29va2llLmtleV0gPSBjb29raWU7XG5cbiAgICAgIHRoaXMuc2F2ZVRvRmlsZSh0aGlzLmZpbGVQYXRoLCB0aGlzLmlkeCwgdGhpcy5vcHRpb24sIGNiKTtcbiAgfVxuXG4gIHB1YmxpYyByZW1vdmVDb29raWUoZG9tYWluOiBzdHJpbmcsIHBhdGg6IHN0cmluZywga2V5OiBzdHJpbmcsIGNiPzogQ2FsbGJhY2spOiB2b2lkIHtcbiAgICAgIGlmICh0aGlzLmlkeFtkb21haW5dICYmIHRoaXMuaWR4W2RvbWFpbl1bcGF0aF0gJiYgdGhpcy5pZHhbZG9tYWluXVtwYXRoXVtrZXldKSB7XG4gICAgICAgICAgZGVsZXRlIHRoaXMuaWR4W2RvbWFpbl1bcGF0aF1ba2V5XTtcbiAgICAgIH1cbiAgICAgIHRoaXMuc2F2ZVRvRmlsZSh0aGlzLmZpbGVQYXRoLCB0aGlzLmlkeCwgdGhpcy5vcHRpb24sIGNiKTtcbiAgfVxuXG4gIHB1YmxpYyByZW1vdmVDb29raWVzKGRvbWFpbjogc3RyaW5nLCBwYXRoOiBzdHJpbmcsIGNiPzogQ2FsbGJhY2spIHtcbiAgICAgIGlmICh0aGlzLmlkeFtkb21haW5dKSB7XG4gICAgICAgICAgaWYgKHBhdGgpIHtcbiAgICAgICAgICAgICAgZGVsZXRlIHRoaXMuaWR4W2RvbWFpbl1bcGF0aF07XG4gICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgZGVsZXRlIHRoaXMuaWR4W2RvbWFpbl07XG4gICAgICAgICAgfVxuICAgICAgfVxuICAgICAgdGhpcy5zYXZlVG9GaWxlKHRoaXMuZmlsZVBhdGgsIHRoaXMuaWR4LCB0aGlzLm9wdGlvbiwgY2IpO1xuICB9XG5cbiAgcHVibGljIGdldENvb2tpZShkb21haW46IHN0cmluZywgcGF0aDogc3RyaW5nLCBrZXk6IHN0cmluZykge1xuICAgICAgaWYgKCF0aGlzLmlkeFtkb21haW5dKSB7XG4gICAgICAgICAgcmV0dXJuIHVuZGVmaW5lZDtcbiAgICAgIH1cbiAgICAgIGlmICghdGhpcy5pZHhbZG9tYWluXVtwYXRoXSkge1xuICAgICAgICAgIHJldHVybiB1bmRlZmluZWQ7XG4gICAgICB9XG4gICAgICByZXR1cm4gdGhpcy5pZHhbZG9tYWluXVtwYXRoXVtrZXldO1xuICB9XG5cbiAgcHVibGljIGZsdXNoKCkge1xuICAgICAgdGhpcy5zYXZlVG9GaWxlKHRoaXMuZmlsZVBhdGgsIHRoaXMuaWR4LCB0aGlzLm9wdGlvbik7XG4gIH07XG5cbiAgcHVibGljIGlzRW1wdHkoKSB7XG4gICAgICByZXR1cm4gdGhpcy5pc0VtcHR5T2JqZWN0KHRoaXMuaWR4KTtcbiAgfVxuXG4gIHByaXZhdGUgaXNFbXB0eU9iamVjdChvYmo6IG9iamVjdCkge1xuICAgICAgZm9yICh2YXIga2V5IGluIG9iaikge1xuICAgICAgICAgIGlmIChvYmouaGFzT3duUHJvcGVydHkuY2FsbChvYmosIGtleSkpIHtcbiAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgICAgIH1cbiAgICAgIH1cbiAgICAgIHJldHVybiB0cnVlO1xuICB9XG5cbiAgcHJpdmF0ZSBzYXZlVG9GaWxlKGZpbGVQYXRoOiBzdHJpbmcsIGRhdGE6IElkeERhdGEsIG9wdGlvbjogT3B0aW9uLCBjYj86IENhbGxiYWNrKTogdm9pZCB7XG4gICAgICB2YXIgZGF0YUpzb24gPSBKU09OLnN0cmluZ2lmeShkYXRhKTtcbiAgICAgIGlmIChvcHRpb24uZW5jcnlwdCkge1xuICAgICAgICAgIHZhciBjaXBoZXIgPSBjcnlwdG8uY3JlYXRlQ2lwaGVyKG9wdGlvbi5hbGdvcml0aG18fCcnLCBvcHRpb24ucGFzc3dvcmR8fCcnKTtcbiAgICAgICAgICBkYXRhSnNvbiA9IGNpcGhlci51cGRhdGUoZGF0YUpzb24sICd1dGY4JywgJ2hleCcpO1xuICAgICAgICAgIGRhdGFKc29uICs9IGNpcGhlci5maW5hbCgnaGV4Jyk7XG4gICAgICB9XG4gICAgICBmcy53cml0ZUZpbGVTeW5jKGZpbGVQYXRoLCBkYXRhSnNvbik7XG4gICAgICBpZiAodHlwZW9mIGNiID09PSAnZnVuY3Rpb24nKSBjYigpO1xuICB9XG5cbiAgcHJpdmF0ZSBsb2FkRnJvbUZpbGUoZmlsZVBhdGg6IHN0cmluZywgb3B0aW9uOiBPcHRpb24sIGNiOiBDYWxsYmFjayk6IHZvaWQge1xuICAgICAgdmFyIGRhdGEgPSBmcy5yZWFkRmlsZVN5bmMoZmlsZVBhdGgsIHtlbmNvZGluZzogJ3V0ZjgnLCBmbGFnOiAnYSsnfSk7XG4gICAgICBpZiAob3B0aW9uLmVuY3J5cHQgJiYgZGF0YSkge1xuICAgICAgICAgIHZhciBkZWNpcGhlciA9IGNyeXB0by5jcmVhdGVEZWNpcGhlcihvcHRpb24uYWxnb3JpdGhtfHwnJywgb3B0aW9uLnBhc3N3b3JkfHwnJyk7XG4gICAgICAgICAgZGF0YSA9IGRlY2lwaGVyLnVwZGF0ZShkYXRhLCAnaGV4JywgJ3V0ZjgnKTtcbiAgICAgICAgICBkYXRhICs9IGRlY2lwaGVyLmZpbmFsKCd1dGY4Jyk7XG4gICAgICB9XG4gICAgICB2YXIgZGF0YUpzb24gPSBkYXRhID8gSlNPTi5wYXJzZShkYXRhKSA6IG51bGw7XG4gICAgICBmb3IgKHZhciBkb21haW5OYW1lIGluIGRhdGFKc29uKSB7XG4gICAgICAgICAgZm9yICh2YXIgcGF0aE5hbWUgaW4gZGF0YUpzb25bZG9tYWluTmFtZV0pIHtcbiAgICAgICAgICAgICAgZm9yICh2YXIgY29va2llTmFtZSBpbiBkYXRhSnNvbltkb21haW5OYW1lXVtwYXRoTmFtZV0pIHtcbiAgICAgICAgICAgICAgICAgIGRhdGFKc29uW2RvbWFpbk5hbWVdW3BhdGhOYW1lXVtjb29raWVOYW1lXSA9IHRvdWdoLmZyb21KU09OKEpTT04uc3RyaW5naWZ5KGRhdGFKc29uW2RvbWFpbk5hbWVdW3BhdGhOYW1lXVtjb29raWVOYW1lXSkpO1xuICAgICAgICAgICAgICB9XG4gICAgICAgICAgfVxuICAgICAgfVxuICAgICAgY2IoZGF0YUpzb24pO1xuICB9XG59XG4iXX0=
